#!/bin/bash

# Scrutiny Collector 配置回调脚本
# 更新配置并重新安装 cron 任务

source "$(dirname "$0")/_functions"

LOG_FILE="${TRIM_PKGVAR}/info.log"
SETTINGS_FILE="${TRIM_PKGVAR}/settings.json"
CRON_TAG="scrutiny-collector-${TRIM_APPNAME}"
COLLECTOR_BIN="${TRIM_APPDEST}/bin/scrutiny-collector-metrics"

log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - [config] $1" >> ${LOG_FILE}
}

# jq 检查
require_jq

log_msg "Config callback started"

# 读取配置向导输入
API_ENDPOINT="${wizard_api_endpoint:-}"
CRON_INTERVAL="${wizard_cron_interval:-}"
HOST_ID="${wizard_host_id:-}"

# 仅在有输入时更新配置
if [ -n "${API_ENDPOINT}" ] || [ -n "${CRON_INTERVAL}" ] || [ -n "${HOST_ID}" ]; then
    # 读取现有配置
    OLD_API=$(read_json_value "${SETTINGS_FILE}" "api_endpoint" "http://localhost:8080")
    OLD_INTERVAL=$(read_json_value "${SETTINGS_FILE}" "cron_interval" "15")
    OLD_HOST_ID=$(read_json_value "${SETTINGS_FILE}" "host_id" "fnOS")

    API_ENDPOINT="${API_ENDPOINT:-${OLD_API}}"
    CRON_INTERVAL="${CRON_INTERVAL:-${OLD_INTERVAL}}"
    HOST_ID="${HOST_ID:-${OLD_HOST_ID}}"

    # URL 安全检查
    API_ENDPOINT=$(sanitize_url "${API_ENDPOINT}") || {
        log_msg "WARNING: API endpoint contains invalid characters, keeping old value"
        API_ENDPOINT="${OLD_API}"
    }

    # 转换 cron 表达式
    CRON_SCHEDULE=$(interval_to_cron "${CRON_INTERVAL}")

    # 使用 jq 写入 settings.json（安全序列化）
    write_settings "${SETTINGS_FILE}" "${API_ENDPOINT}" "${CRON_SCHEDULE}" "${CRON_INTERVAL}" "${HOST_ID}"

    log_msg "Settings updated: api_endpoint=${API_ENDPOINT}, cron_schedule=${CRON_SCHEDULE}, host_id=${HOST_ID}"

    # 重新安装 cron 任务（如果正在运行中）
    if crontab -l 2>/dev/null | grep -q "# ${CRON_TAG}"; then
        crontab -l 2>/dev/null | grep -v "# ${CRON_TAG}" | crontab - 2>/dev/null
        cron_cmd="${CRON_SCHEDULE} PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin ${COLLECTOR_BIN} run --api-endpoint \"${API_ENDPOINT}\" --host-id \"${HOST_ID}\" >> \"${LOG_FILE}\" 2>&1 # ${CRON_TAG}"
        (crontab -l 2>/dev/null; echo "${cron_cmd}") | crontab -
        log_msg "Cron job reinstalled"
    fi
fi

log_msg "Config callback completed"
